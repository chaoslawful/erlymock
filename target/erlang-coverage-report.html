<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at Feb 7, 2011 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=${outputEncoding}" />
    <title>Test Coverage Report</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20110207" />
    <meta http-equiv="Content-Language" content="en" />
        
  </head>
  <body class="composite">
    <div id="banner">
                      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
        
                <div class="xleft">
        <span id="publishDate">Last Published: 2011-02-07</span>
                  &nbsp;| <span id="projectVersion">Version: ${project.version}</span>
                      </div>
            <div class="xright">        
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
        
                                      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
        
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>Test Coverage Report<a name="Test_Coverage_Report"></a></h2><p>Test coverage results, as reported by the Erlang coverage analysis tool.</p></div><div class="section"><h3>Summary<a name="Summary"></a></h3></div><!-- summary: 84,1,22,29,84,71,13 --><table align="center" border="0" class="bodyTable"><tr class="a"><th></th><th>Coverage</th><th>Modules</th><th>Functions</th><th>Clauses</th><th>Lines</th><th>Covered lines</th><th>Not covered lines</th></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>84%</td><td>1</td><td>22</td><td>29</td><td>84</td><td>71</td><td>13</td></tr></table><div class="section"><h3>Modules<a name="Modules"></a></h3></div><table align="center" border="0" class="bodyTable"><tr class="a"><th></th><th>Coverage</th><th>Module</th><th>Functions</th><th>Clauses</th><th>Lines</th><th>Covered lines</th><th>Not covered lines</th></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>84%</td><td><a href="#em">em</a></td><td>22</td><td>29</td><td>84</td><td>71</td><td>13</td></tr></table><div class="section"><h4><a name="em">em</a></div><table align="center" border="0" class="bodyTable"><tr class="a"><th></th><th>Coverage</th><th>Function</th><th>Clauses</th><th>Lines</th><th>Covered lines</th><th>Not covered lines</th></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>72%</td><td>check_args/2</td><td>1</td><td>11</td><td>8</td><td>3</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>invoke/4</td><td>1</td><td>3</td><td>3</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>body_syn/3</td><td>1</td><td>3</td><td>3</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>any/0</td><td>1</td><td>2</td><td>2</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>strict/4</td><td>1</td><td>1</td><td>1</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>mock_fun_syn/3</td><td>1</td><td>3</td><td>3</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>strict/5</td><td>2</td><td>2</td><td>2</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>programming/3</td><td>3</td><td>6</td><td>6</td><td>0</td></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>50%</td><td>replaying/3</td><td>3</td><td>12</td><td>6</td><td>6</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>stub/5</td><td>2</td><td>2</td><td>2</td><td>0</td></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>60%</td><td>no_expectations/3</td><td>2</td><td>5</td><td>3</td><td>2</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>unload_modules/1</td><td>1</td><td>4</td><td>4</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>install_mock_module/2</td><td>1</td><td>11</td><td>11</td><td>0</td></tr><tr class="a"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>0%</td><td>stub/4</td><td>1</td><td>1</td><td>0</td><td>1</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>init/1</td><td>1</td><td>1</td><td>1</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>new/0</td><td>1</td><td>2</td><td>2</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>var_list_syn/1</td><td>1</td><td>2</td><td>2</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>terminate/3</td><td>1</td><td>1</td><td>1</td><td>0</td></tr><tr class="b"><td><img src="images/icon_warning_sml.gif" alt="" /></td><td>83%</td><td>handle_stub_invokation/2</td><td>1</td><td>6</td><td>5</td><td>1</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>verify/1</td><td>1</td><td>1</td><td>1</td><td>0</td></tr><tr class="b"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>replay/1</td><td>1</td><td>1</td><td>1</td><td>0</td></tr><tr class="a"><td><img src="images/icon_success_sml.gif" alt="" /></td><td>100%</td><td>install_mock_modules/1</td><td>1</td><td>4</td><td>4</td><td>0</td></tr></table><div class="source"><pre><span ><a name="em-1">0001</a>: %%%-------------------------------------------------------------------</span>
<span ><a name="em-2">0002</a>: %%% @author Sven Heyll &lt;sven.heyll@lindenbaum.eu&gt;</span>
<span ><a name="em-3">0003</a>: %%% @doc</span>
<span ><a name="em-4">0004</a>: %%% 'em' stands for 'Early Mock'.</span>
<span ><a name="em-5">0005</a>: %%% A mocking library that works similar to easymock. Code for modules </span>
<span ><a name="em-6">0006</a>: %%% that should be mocked is created and loaded on the fly.</span>
<span ><a name="em-7">0007</a>: %%% @end</span>
<span ><a name="em-8">0008</a>: %%% @copyright (C) 2011, Sven Heyll</span>
<span ><a name="em-9">0009</a>: %%%-------------------------------------------------------------------</span>
<span ><a name="em-10">0010</a>: -module(em).</span>
<span ><a name="em-11">0011</a>: </span>
<span ><a name="em-12">0012</a>: -behaviour(gen_fsm).</span>
<span ><a name="em-13">0013</a>: </span>
<span ><a name="em-14">0014</a>: -export([new/0,</span>
<span ><a name="em-15">0015</a>:          strict/4,</span>
<span ><a name="em-16">0016</a>:          strict/5,</span>
<span ><a name="em-17">0017</a>:          stub/4,</span>
<span ><a name="em-18">0018</a>:          stub/5,</span>
<span ><a name="em-19">0019</a>:          replay/1,</span>
<span ><a name="em-20">0020</a>:          verify/1,</span>
<span ><a name="em-21">0021</a>:          any/0]).</span>
<span ><a name="em-22">0022</a>: </span>
<span ><a name="em-23">0023</a>: -export([programming/3,</span>
<span ><a name="em-24">0024</a>:          replaying/3,</span>
<span ><a name="em-25">0025</a>:          no_expectations/3,</span>
<span ><a name="em-26">0026</a>:          terminate/3,</span>
<span ><a name="em-27">0027</a>:          init/1]).</span>
<span ><a name="em-28">0028</a>: </span>
<span ><a name="em-29">0029</a>: %% !!!NEVER CALL THIS FUNCTION!!! ---</span>
<span ><a name="em-30">0030</a>: -export([invoke/4]).</span>
<span ><a name="em-31">0031</a>: </span>
<span ><a name="em-32">0032</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-33">0033</a>: %%%% important types</span>
<span ><a name="em-34">0034</a>: %%</span>
<span ><a name="em-35">0035</a>: </span>
<span ><a name="em-36">0036</a>: -type args() :: [ fun((any()) -&gt;</span>
<span ><a name="em-37">0037</a>:                              true | false)</span>
<span ><a name="em-38">0038</a>:                      | term()].</span>
<span ><a name="em-39">0039</a>: </span>
<span ><a name="em-40">0040</a>: -type answer() :: {function, fun(([any()]) -&gt; any())} </span>
<span ><a name="em-41">0041</a>:                   | {return, any()} .</span>
<span ><a name="em-42">0042</a>: </span>
<span ><a name="em-43">0043</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-44">0044</a>: %%%% API</span>
<span ><a name="em-45">0045</a>: %%</span>
<span ><a name="em-46">0046</a>: </span>
<span ><a name="em-47">0047</a>: -spec any() -&gt;</span>
<span ><a name="em-48">0048</a>:                  fun((any()) -&gt;</span>
<span ><a name="em-49">0049</a>:                     true).</span>
<span ><a name="em-50">0050</a>: any() -&gt;</span>
<span style="background: #afa;"><a name="em-51">0051</a>:     fun(_) -&gt;</span>
<span style="background: #afa;"><a name="em-52">0052</a>:             true</span>
<span ><a name="em-53">0053</a>:     end.</span>
<span ><a name="em-54">0054</a>: </span>
<span ><a name="em-55">0055</a>: -spec new() -&gt;</span>
<span ><a name="em-56">0056</a>:                  pid().</span>
<span ><a name="em-57">0057</a>: new() -&gt;    </span>
<span style="background: #afa;"><a name="em-58">0058</a>:     {ok, Pid} = gen_fsm:start_link(?MODULE, [], []),</span>
<span style="background: #afa;"><a name="em-59">0059</a>:     Pid.</span>
<span ><a name="em-60">0060</a>: </span>
<span ><a name="em-61">0061</a>: -spec strict(pid(), atom(), atom(), args()) -&gt;</span>
<span ><a name="em-62">0062</a>:                     ok.</span>
<span ><a name="em-63">0063</a>: strict(M, Mod, Fun, Args)</span>
<span ><a name="em-64">0064</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-65">0065</a>:     strict(M, Mod, Fun, Args, {return, ok}).</span>
<span ><a name="em-66">0066</a>: </span>
<span ><a name="em-67">0067</a>: -spec strict(pid(), atom(), atom(), args(), answer()) -&gt;</span>
<span ><a name="em-68">0068</a>:                     ok.</span>
<span ><a name="em-69">0069</a>: strict(M, Mod, Fun, Args, Answer = {return, _}) </span>
<span ><a name="em-70">0070</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-71">0071</a>:     ok = gen_fsm:sync_send_event(M, {strict, Mod, Fun, Args, Answer});</span>
<span ><a name="em-72">0072</a>: strict(M, Mod, Fun, Args, Answer = {function, _})</span>
<span ><a name="em-73">0073</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-74">0074</a>:     ok = gen_fsm:sync_send_event(M, {strict, Mod, Fun, Args, Answer}).</span>
<span ><a name="em-75">0075</a>: </span>
<span ><a name="em-76">0076</a>: -spec stub(pid(), atom(), atom(), args()) -&gt;</span>
<span ><a name="em-77">0077</a>:                   ok.</span>
<span ><a name="em-78">0078</a>: stub(M, Mod, Fun, Args)</span>
<span ><a name="em-79">0079</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #faa;"><a name="em-80">0080</a>:     stub(M, Mod, Fun, Args, {return, ok}).</span>
<span ><a name="em-81">0081</a>: </span>
<span ><a name="em-82">0082</a>: -spec stub(pid(), atom(), atom(), args(), answer()) -&gt;</span>
<span ><a name="em-83">0083</a>:                   ok.</span>
<span ><a name="em-84">0084</a>: stub(M, Mod, Fun, Args, Answer = {return, _}) </span>
<span ><a name="em-85">0085</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-86">0086</a>:     ok = gen_fsm:sync_send_event(M, {stub, Mod, Fun, Args, Answer});</span>
<span ><a name="em-87">0087</a>: stub(M, Mod, Fun, Args, Answer = {function, _}) </span>
<span ><a name="em-88">0088</a>:   when is_pid(M), is_atom(Mod), is_atom(Fun), is_list(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-89">0089</a>:     ok = gen_fsm:sync_send_event(M, {stub, Mod, Fun, Args, Answer}).</span>
<span ><a name="em-90">0090</a>: </span>
<span ><a name="em-91">0091</a>: replay(M) -&gt;</span>
<span style="background: #afa;"><a name="em-92">0092</a>:     ok = gen_fsm:sync_send_event(M, replay).</span>
<span ><a name="em-93">0093</a>: </span>
<span ><a name="em-94">0094</a>: verify(M) -&gt;</span>
<span style="background: #afa;"><a name="em-95">0095</a>:     ok = gen_fsm:sync_send_event(M, verify).</span>
<span ><a name="em-96">0096</a>: </span>
<span ><a name="em-97">0097</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-98">0098</a>: %%%% internal state</span>
<span ><a name="em-99">0099</a>: %%</span>
<span ><a name="em-100">0100</a>: </span>
<span ><a name="em-101">0101</a>: -record(expectation, </span>
<span ><a name="em-102">0102</a>:         {m :: atom(), </span>
<span ><a name="em-103">0103</a>:          f :: atom(), </span>
<span ><a name="em-104">0104</a>:          a :: args(), </span>
<span ><a name="em-105">0105</a>:          answer :: answer()}).</span>
<span ><a name="em-106">0106</a>: </span>
<span ><a name="em-107">0107</a>: -record(state, {</span>
<span ><a name="em-108">0108</a>:           strict :: [#expectation{}],</span>
<span ><a name="em-109">0109</a>:           stub  :: [#expectation{}],</span>
<span ><a name="em-110">0110</a>:           mocked_modules :: [atom()]</span>
<span ><a name="em-111">0111</a>:          }).</span>
<span ><a name="em-112">0112</a>: </span>
<span ><a name="em-113">0113</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-114">0114</a>: %%%% gen_fsm callbacks</span>
<span ><a name="em-115">0115</a>: %%</span>
<span ><a name="em-116">0116</a>: init([]) -&gt;</span>
<span ><a name="em-117">0117</a>:  %   process_flag(trap_exit, true),</span>
<span style="background: #afa;"><a name="em-118">0118</a>:     {ok, </span>
<span ><a name="em-119">0119</a>:      programming, </span>
<span ><a name="em-120">0120</a>:      #state{</span>
<span ><a name="em-121">0121</a>:        strict = [], </span>
<span ><a name="em-122">0122</a>:        stub = [],</span>
<span ><a name="em-123">0123</a>:        mocked_modules = []}}.</span>
<span ><a name="em-124">0124</a>: </span>
<span ><a name="em-125">0125</a>: </span>
<span ><a name="em-126">0126</a>: programming({strict, Mod, Fun, Args, Answer}, </span>
<span ><a name="em-127">0127</a>:             _From, </span>
<span ><a name="em-128">0128</a>:             State = #state{strict = Strict}) -&gt;</span>
<span style="background: #afa;"><a name="em-129">0129</a>:     {reply, </span>
<span ><a name="em-130">0130</a>:      ok, </span>
<span ><a name="em-131">0131</a>:      programming, </span>
<span ><a name="em-132">0132</a>:      State#state{</span>
<span ><a name="em-133">0133</a>:        strict = [#expectation{m = Mod, f = Fun, a = Args, answer = Answer}|Strict]}};</span>
<span ><a name="em-134">0134</a>:     </span>
<span ><a name="em-135">0135</a>: programming({stub, Mod, Fun, Args, Answer}, </span>
<span ><a name="em-136">0136</a>:             _From, </span>
<span ><a name="em-137">0137</a>:             State = #state{stub = Stub}) -&gt;</span>
<span style="background: #afa;"><a name="em-138">0138</a>:     {reply, </span>
<span ><a name="em-139">0139</a>:      ok, </span>
<span ><a name="em-140">0140</a>:      programming, </span>
<span ><a name="em-141">0141</a>:      State#state{</span>
<span ><a name="em-142">0142</a>:        stub = [#expectation{m = Mod, f = Fun, a = Args, answer = Answer}|Stub]}};</span>
<span ><a name="em-143">0143</a>:     </span>
<span ><a name="em-144">0144</a>: programming(replay, </span>
<span ><a name="em-145">0145</a>:             _From, </span>
<span ><a name="em-146">0146</a>:             State = #state{strict = Strict}) -&gt;</span>
<span style="background: #afa;"><a name="em-147">0147</a>:     MMs = install_mock_modules(State),</span>
<span style="background: #afa;"><a name="em-148">0148</a>:     {reply, </span>
<span ><a name="em-149">0149</a>:      ok, </span>
<span ><a name="em-150">0150</a>:      case Strict of</span>
<span style="background: #afa;"><a name="em-151">0151</a>:          [] -&gt; no_expectations;</span>
<span style="background: #afa;"><a name="em-152">0152</a>:          _ -&gt; replaying</span>
<span ><a name="em-153">0153</a>:      end, </span>
<span ><a name="em-154">0154</a>:      State#state{</span>
<span ><a name="em-155">0155</a>:        strict = lists:reverse(Strict),       </span>
<span ><a name="em-156">0156</a>:        mocked_modules = MMs}}.</span>
<span ><a name="em-157">0157</a>: </span>
<span ><a name="em-158">0158</a>: replaying(I = {invokation, Mod, Fun, Args}, </span>
<span ><a name="em-159">0159</a>:           _From, </span>
<span ><a name="em-160">0160</a>:           State = #state{</span>
<span ><a name="em-161">0161</a>:             strict = [#expectation{</span>
<span ><a name="em-162">0162</a>:                         m      = Mod, </span>
<span ><a name="em-163">0163</a>:                         f      = Fun, </span>
<span ><a name="em-164">0164</a>:                         a      = EArgs, </span>
<span ><a name="em-165">0165</a>:                         answer = Answer}</span>
<span ><a name="em-166">0166</a>:                       |Rest]})</span>
<span ><a name="em-167">0167</a>:   when length(EArgs) == length(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-168">0168</a>:     case check_args(Args, EArgs) of</span>
<span ><a name="em-169">0169</a>:         true -&gt;</span>
<span style="background: #afa;"><a name="em-170">0170</a>:             {reply, </span>
<span ><a name="em-171">0171</a>:              Answer, </span>
<span ><a name="em-172">0172</a>:              case Rest of</span>
<span style="background: #afa;"><a name="em-173">0173</a>:                  [] -&gt; no_expectations;</span>
<span style="background: #afa;"><a name="em-174">0174</a>:                  _ -&gt; replaying</span>
<span ><a name="em-175">0175</a>:              end, </span>
<span ><a name="em-176">0176</a>:              State#state{strict=Rest}};</span>
<span ><a name="em-177">0177</a>:         {error, {PIndex, PValue}} -&gt;</span>
<span style="background: #faa;"><a name="em-178">0178</a>:             Reason = {unexpected_function_parameter, </span>
<span ><a name="em-179">0179</a>:                       {parameter, PIndex, PValue}, </span>
<span ><a name="em-180">0180</a>:                       {invokation, I}},</span>
<span style="background: #faa;"><a name="em-181">0181</a>:             {stop, Reason, Reason, State}</span>
<span ><a name="em-182">0182</a>:     end;</span>
<span ><a name="em-183">0183</a>: </span>
<span ><a name="em-184">0184</a>: replaying(I = {invokation, _M, _F, _A}, </span>
<span ><a name="em-185">0185</a>:           _From, </span>
<span ><a name="em-186">0186</a>:           State = #state{strict = [E|_]}) -&gt;</span>
<span style="background: #afa;"><a name="em-187">0187</a>:     case handle_stub_invokation(I, State#state.stub) of</span>
<span ><a name="em-188">0188</a>:         {ok, Answer} -&gt;</span>
<span style="background: #afa;"><a name="em-189">0189</a>:             {reply, Answer, replaying, State};</span>
<span ><a name="em-190">0190</a>: </span>
<span ><a name="em-191">0191</a>:         error -&gt;            </span>
<span style="background: #faa;"><a name="em-192">0192</a>:             Reason = {unexpected_invokation, {actual, I}, {expected, E}},</span>
<span style="background: #faa;"><a name="em-193">0193</a>:             {stop, Reason, Reason, State}</span>
<span ><a name="em-194">0194</a>:     end;</span>
<span ><a name="em-195">0195</a>: </span>
<span ><a name="em-196">0196</a>: replaying(verify,</span>
<span ><a name="em-197">0197</a>:           _From,</span>
<span ><a name="em-198">0198</a>:           State) -&gt;</span>
<span style="background: #faa;"><a name="em-199">0199</a>:     Reason = {invokations_missing, State#state.strict},</span>
<span style="background: #faa;"><a name="em-200">0200</a>:     {stop, Reason, Reason, State}.</span>
<span ><a name="em-201">0201</a>: </span>
<span ><a name="em-202">0202</a>: no_expectations(I = {invokation, _M, _F, _A}, _From, State) -&gt;</span>
<span style="background: #afa;"><a name="em-203">0203</a>:     case handle_stub_invokation(I, State#state.stub) of</span>
<span ><a name="em-204">0204</a>:         {ok, Answer} -&gt;</span>
<span style="background: #afa;"><a name="em-205">0205</a>:             {reply, Answer, no_expectations, State};</span>
<span ><a name="em-206">0206</a>: </span>
<span ><a name="em-207">0207</a>:         error -&gt;</span>
<span style="background: #faa;"><a name="em-208">0208</a>:             Reason = {unexpected_invokation, {actual, I}},</span>
<span style="background: #faa;"><a name="em-209">0209</a>:             {stop, Reason, Reason, State}</span>
<span ><a name="em-210">0210</a>:     end;</span>
<span ><a name="em-211">0211</a>:         </span>
<span ><a name="em-212">0212</a>: no_expectations(verify,</span>
<span ><a name="em-213">0213</a>:          _From,</span>
<span ><a name="em-214">0214</a>:          State) -&gt;</span>
<span style="background: #afa;"><a name="em-215">0215</a>:     {stop, normal, ok, State}.</span>
<span ><a name="em-216">0216</a>: </span>
<span ><a name="em-217">0217</a>: terminate(_Reason, _StateName, State) -&gt;</span>
<span style="background: #afa;"><a name="em-218">0218</a>:     unload_modules(State).</span>
<span ><a name="em-219">0219</a>: </span>
<span ><a name="em-220">0220</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-221">0221</a>: %%%% api for generated mock code</span>
<span ><a name="em-222">0222</a>: %%</span>
<span ><a name="em-223">0223</a>: </span>
<span ><a name="em-224">0224</a>: invoke(M, Mod, Fun, Args) -&gt;</span>
<span style="background: #afa;"><a name="em-225">0225</a>:     case gen_fsm:sync_send_event(M, {invokation, Mod, Fun, Args}) of</span>
<span ><a name="em-226">0226</a>:         {return, Value} -&gt;</span>
<span style="background: #afa;"><a name="em-227">0227</a>:             Value;</span>
<span ><a name="em-228">0228</a>:         {function, F} -&gt;</span>
<span style="background: #afa;"><a name="em-229">0229</a>:             F(Args)</span>
<span ><a name="em-230">0230</a>:     end.</span>
<span ><a name="em-231">0231</a>: </span>
<span ><a name="em-232">0232</a>: %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
<span ><a name="em-233">0233</a>: %%%% internal functions</span>
<span ><a name="em-234">0234</a>: %%</span>
<span ><a name="em-235">0235</a>: unload_modules(#state{mocked_modules = MMs}) -&gt;</span>
<span style="background: #afa;"><a name="em-236">0236</a>:     [begin</span>
<span style="background: #afa;"><a name="em-237">0237</a>:          code:delete(Mod),</span>
<span style="background: #afa;"><a name="em-238">0238</a>:          code:purge(Mod)</span>
<span ><a name="em-239">0239</a>:      end</span>
<span style="background: #afa;"><a name="em-240">0240</a>:      || Mod &lt;- MMs].</span>
<span ><a name="em-241">0241</a>: </span>
<span ><a name="em-242">0242</a>: install_mock_modules(#state{strict = ExpectationsStrict,</span>
<span ><a name="em-243">0243</a>:                             stub = ExpectationsStub}) -&gt;</span>
<span style="background: #afa;"><a name="em-244">0244</a>:     Expectations = ExpectationsStub ++ ExpectationsStrict,</span>
<span style="background: #afa;"><a name="em-245">0245</a>:     ModulesToMock = lists:usort([M || #expectation{m = M} &lt;- Expectations]),</span>
<span style="background: #afa;"><a name="em-246">0246</a>:     [install_mock_module(M, Expectations) || M &lt;- ModulesToMock],</span>
<span style="background: #afa;"><a name="em-247">0247</a>:     ModulesToMock.</span>
<span ><a name="em-248">0248</a>: </span>
<span ><a name="em-249">0249</a>: install_mock_module(Mod, Expectations) -&gt;</span>
<span style="background: #afa;"><a name="em-250">0250</a>:     ModHeaderSyn = [erl_syntax:attribute(erl_syntax:atom(module), </span>
<span ><a name="em-251">0251</a>:                                       [erl_syntax:atom(Mod)]),</span>
<span ><a name="em-252">0252</a>:                     erl_syntax:attribute(erl_syntax:atom(compile), </span>
<span ><a name="em-253">0253</a>:                                          [erl_syntax:list(</span>
<span ><a name="em-254">0254</a>:                                             [erl_syntax:atom(export_all)])])],</span>
<span style="background: #afa;"><a name="em-255">0255</a>:     Funs = lists:usort(</span>
<span style="background: #afa;"><a name="em-256">0256</a>:              [{F, length(A)} || #expectation{m = M, f = F, a = A} &lt;- Expectations,</span>
<span style="background: #afa;"><a name="em-257">0257</a>:                                 M == Mod]),</span>
<span style="background: #afa;"><a name="em-258">0258</a>:     FunFormsSyn = [mock_fun_syn(Mod, F, A) || {F, A} &lt;- Funs],</span>
<span ><a name="em-259">0259</a>: </span>
<span style="background: #afa;"><a name="em-260">0260</a>:     {ok, Mod, Code} = </span>
<span style="background: #afa;"><a name="em-261">0261</a>:         compile:forms([erl_syntax:revert(F) </span>
<span style="background: #afa;"><a name="em-262">0262</a>:                        || F &lt;- ModHeaderSyn ++ FunFormsSyn]),</span>
<span ><a name="em-263">0263</a>: </span>
<span style="background: #afa;"><a name="em-264">0264</a>:     code:delete(Mod),</span>
<span style="background: #afa;"><a name="em-265">0265</a>:     code:purge(Mod),</span>
<span style="background: #afa;"><a name="em-266">0266</a>:     {module, _} = load_module(Mod, Code).</span>
<span ><a name="em-267">0267</a>: </span>
<span ><a name="em-268">0268</a>: </span>
<span ><a name="em-269">0269</a>: mock_fun_syn(Mod, F, Args) -&gt;</span>
<span style="background: #afa;"><a name="em-270">0270</a>:     ArgsSyn = var_list_syn(Args),</span>
<span style="background: #afa;"><a name="em-271">0271</a>:     FunSyn = erl_syntax:atom(F),</span>
<span style="background: #afa;"><a name="em-272">0272</a>:     erl_syntax:function(</span>
<span ><a name="em-273">0273</a>:        FunSyn,</span>
<span ><a name="em-274">0274</a>:        [erl_syntax:clause(ArgsSyn,</span>
<span ><a name="em-275">0275</a>:                           none,</span>
<span ><a name="em-276">0276</a>:                           body_syn(Mod, FunSyn, ArgsSyn))]).</span>
<span ><a name="em-277">0277</a>: </span>
<span ><a name="em-278">0278</a>: var_list_syn(Args) -&gt;</span>
<span style="background: #afa;"><a name="em-279">0279</a>:     [erl_syntax:variable(list_to_atom("Arg_" ++ integer_to_list(I))) </span>
<span style="background: #afa;"><a name="em-280">0280</a>:      || I &lt;- lists:seq(0, Args - 1)].</span>
<span ><a name="em-281">0281</a>:                         </span>
<span ><a name="em-282">0282</a>: body_syn(Mod, FunSyn, ArgsSyn) -&gt;</span>
<span style="background: #afa;"><a name="em-283">0283</a>:     SelfStr = pid_to_list(self()),</span>
<span style="background: #afa;"><a name="em-284">0284</a>:     SelfSyn = erl_syntax:application(</span>
<span ><a name="em-285">0285</a>:                 erl_syntax:atom(erlang),</span>
<span ><a name="em-286">0286</a>:                 erl_syntax:atom(list_to_pid),</span>
<span ><a name="em-287">0287</a>:                 [erl_syntax:string(SelfStr)]),</span>
<span style="background: #afa;"><a name="em-288">0288</a>:     [erl_syntax:application(</span>
<span ><a name="em-289">0289</a>:        erl_syntax:atom(?MODULE),</span>
<span ><a name="em-290">0290</a>:        erl_syntax:atom(invoke),</span>
<span ><a name="em-291">0291</a>:        [SelfSyn,  </span>
<span ><a name="em-292">0292</a>:         erl_syntax:atom(Mod), </span>
<span ><a name="em-293">0293</a>:         FunSyn,</span>
<span ><a name="em-294">0294</a>:         erl_syntax:list(ArgsSyn)])].</span>
<span ><a name="em-295">0295</a>: </span>
<span ><a name="em-296">0296</a>: check_args(Args, ArgSpecs) -&gt;</span>
<span style="background: #afa;"><a name="em-297">0297</a>:     try</span>
<span style="background: #afa;"><a name="em-298">0298</a>:         [begin </span>
<span style="background: #afa;"><a name="em-299">0299</a>:              if </span>
<span ><a name="em-300">0300</a>:                  is_function(E) -&gt;</span>
<span style="background: #afa;"><a name="em-301">0301</a>:                      case E(A) of</span>
<span ><a name="em-302">0302</a>:                          true -&gt;</span>
<span style="background: #afa;"><a name="em-303">0303</a>:                              ok;</span>
<span ><a name="em-304">0304</a>:                          _ -&gt;</span>
<span style="background: #faa;"><a name="em-305">0305</a>:                              throw({error, {I, A}})</span>
<span ><a name="em-306">0306</a>:                      end;</span>
<span ><a name="em-307">0307</a>:                  </span>
<span ><a name="em-308">0308</a>:                  A =/= E -&gt;</span>
<span style="background: #faa;"><a name="em-309">0309</a>:                      throw({error, {expected, E}, {actual, A}});</span>
<span ><a name="em-310">0310</a>: </span>
<span ><a name="em-311">0311</a>:                  A == E -&gt;</span>
<span style="background: #afa;"><a name="em-312">0312</a>:                      ok</span>
<span ><a name="em-313">0313</a>:              end</span>
<span ><a name="em-314">0314</a>:          end </span>
<span style="background: #afa;"><a name="em-315">0315</a>:          || {I, A, E} &lt;- lists:zip3(lists:seq(0, length(Args) - 1),</span>
<span ><a name="em-316">0316</a>:                                     Args,</span>
<span ><a name="em-317">0317</a>:                                     ArgSpecs)] of</span>
<span ><a name="em-318">0318</a>:         _ -&gt;</span>
<span style="background: #afa;"><a name="em-319">0319</a>:             true</span>
<span ><a name="em-320">0320</a>:     catch </span>
<span ><a name="em-321">0321</a>:         _:E -&gt;</span>
<span style="background: #faa;"><a name="em-322">0322</a>:             E</span>
<span ><a name="em-323">0323</a>:     end.</span>
<span ><a name="em-324">0324</a>:                  </span>
<span ><a name="em-325">0325</a>: handle_stub_invokation({invokation, Mod, Fun, Args}, Stubs) -&gt;</span>
<span style="background: #afa;"><a name="em-326">0326</a>:     case [MatchingStub </span>
<span style="background: #afa;"><a name="em-327">0327</a>:           || MatchingStub = #expectation {m = M, f = F, a = A} &lt;- Stubs,</span>
<span style="background: #afa;"><a name="em-328">0328</a>:              M == Mod, F == Fun, length(Args) == length(A),</span>
<span style="background: #afa;"><a name="em-329">0329</a>:              check_args(Args, A) == true] of</span>
<span ><a name="em-330">0330</a>: </span>
<span ><a name="em-331">0331</a>:         [#expectation{answer = Answer}|_] -&gt;</span>
<span style="background: #afa;"><a name="em-332">0332</a>:             {ok, Answer};</span>
<span ><a name="em-333">0333</a>: </span>
<span ><a name="em-334">0334</a>:         _ -&gt;            </span>
<span style="background: #faa;"><a name="em-335">0335</a>:             error</span>
<span ><a name="em-336">0336</a>:     end.</span>
<span ><a name="em-337">0337</a>:     </span>
</pre></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">Copyright &#169;  All Rights Reserved.      
        
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
